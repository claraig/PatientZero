[gd_scene load_steps=16 format=2]

[ext_resource path="res://assets/town/town2.jpg" type="Texture" id=1]
[ext_resource path="res://assets/town/school.jpg" type="Texture" id=2]
[ext_resource path="res://assets/town/work.jpg" type="Texture" id=3]
[ext_resource path="res://assets/town/restaurant.jpg" type="Texture" id=4]
[ext_resource path="res://assets/town/airport.jpg" type="Texture" id=5]
[ext_resource path="res://assets/town/Mall.jpg" type="Texture" id=6]
[ext_resource path="res://assets/town/market.jpg" type="Texture" id=7]
[ext_resource path="res://scripts/place.gd" type="Script" id=18]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

var turnoAtual:int
var quantidadeDoentes:int = 0
var quantidadeMortos:int = 0
var pessoas
var lugares
var pacienteZero
var venceu = false
# Declare member variables here. Examples:
# var a = 2
# var b = \"text\"


# Called when the node enters the scene tree for the first time.
func _ready():
	turnoAtual = 0
	venceu = false
	pessoas = get_node(\"Population\").get_children()
	print(pessoas)
	lugares = get_node(\"Places\").get_children()
	_passarTurno()
	_atualizarInfos()

func _atualizarInfos():
	var texto = \"Turno Atual: \" + str(turnoAtual) + \"  Doentes: \" + str(quantidadeDoentes) + \"  Mortos: \" + str(quantidadeMortos)
	get_node(\"InfoTurno\").set_text(texto)

func _encontraPacienteZero():
	for n in pessoas:
		if(n.pacienteZero == 1):
			pacienteZero = n

func _movimentoPacienteZero():
	var lugaresFrequentados = []
	var pessoasEncontradas = []
	for i in range(0, 1):

		pacienteZero.inte

func _movimentoVisitacao():
	for p in pessoas:
		if (p.imunidade > 0 && p.name != get_node(\"Population\").isolado):
			randomize()
			var place1 = randi()%lugares.size()-1
			randomize()
			var place2 = randi()%lugares.size()-1
			if (place1 == place2):
				place2+=1
				lugares[place1].visitantes[turnoAtual-1].pessoas.push_back(p.name)
				lugares[place2].visitantes[turnoAtual-1].pessoas.push_back(p.name)
			else:
				lugares[place1].visitantes[turnoAtual-1].pessoas.push_back(p.name)
				lugares[place2].visitantes[turnoAtual-1].pessoas.push_back(p.name)

func _inserirTurnoLugares():
	for l in lugares:
		l.visitantes.push_back({\"turno\":turnoAtual,\"pessoas\":[]})

func _passandoDoenca():
	var contaminadas = []
	for p in pessoas:
		if(p.doente || p.pacienteZero):
			for l in lugares:
				if(l.visitantes[turnoAtual-1].pessoas.has(p.name) && l.visitantes[turnoAtual-1].pessoas.size() > 1):
					contaminadas.push_back(_retornaContaminada(p.name, l.visitantes[turnoAtual-1].pessoas))
	print(contaminadas)
	for p in pessoas:
		if(contaminadas.has(p.name) && (!p.doente && !p.pacienteZero)):
			p.doente = true
			quantidadeDoentes+=1
			p.turnoAdoecimento = turnoAtual
			p.get_node(\"Button\").add_color_override(\"font_color\", Color(9,248,43))

func _retornaContaminada(doente, visitantes):
	var sorteado = doente
	var randon
	while(sorteado == doente):
		randon = randi() % visitantes.size()-1
		sorteado = visitantes[randon]
	return sorteado

func _diminuindoImunidade():
	for p in pessoas:
		if(p.doente && p.imunidade > 0):
			p.imunidade-=1
		if(p.imunidade == 0 && !p.morta):
			p.morta = true
			quantidadeMortos+=1
			p.get_node(\"Button\").visible = false
			if(quantidadeDoentes > 0):
				quantidadeDoentes-=1


func _venceu():
	for p in pessoas:
		if(p.name == get_node(\"Population\").isolado && p.pacienteZero):
			venceu = true


func _passarTurno():
	turnoAtual+=1
	_venceu()
	if(!venceu):
		_inserirTurnoLugares()
		_movimentoVisitacao()
		_diminuindoImunidade()
		_passandoDoenca()
		_tirarIsolamento()
		_atualizarInfos()
	else:
		get_node(\"InfoTurno\").set_text(\"Você encontrou o paciente zero, parabéns!\")

func _tirarIsolamento():
	get_node(\"Population\").isolado = \"\"
	get_node(\"Population\").selecionado = \"\"
	for p in pessoas:
		p.get_node(\"Button\").disabled = false

func _on_NextTurn_button_down():
	if(quantidadeMortos < pessoas.size()-1):
		_passarTurno()
	else:
		get_node(\"InfoTurno\").set_text(\"Todos Morreram! FIm de Jogo =(\")
"

[sub_resource type="Gradient" id=2]
offsets = PoolRealArray( 0.754286 )
colors = PoolColorArray( 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=3]
gradient = SubResource( 2 )
width = 1

[sub_resource type="StyleBoxFlat" id=4]

[sub_resource type="StyleBoxFlat" id=5]

[sub_resource type="GDScript" id=6]
script/source = "extends Node


# Declare member variables here. Examples:
# var a = 2
# var b = \"text\"
var isolado:String = \"\"
var selecionado:String = \"\"


# Called when the node enters the scene tree for the first time.
func _ready():
	_inicializaPessoas()
	_inicializarPacienteZero()
	_printPessoas()
	
				
func _inicializaPessoas():
	var listaPessoas = get_children()
	for n in listaPessoas : 
		randomize()
		n.imunidade = rand_range(1,5)
		
func _inicializarPacienteZero():
	randomize()
	var listaPessoas = get_children()
	print(listaPessoas.size())
	var sorteado = rand_range(0, listaPessoas.size())
	listaPessoas[sorteado].pacienteZero = true


func _printPessoas():
	var listaPessoas = get_children()
	for n in listaPessoas : 
		print(n.name) 
		print(\"Imunidade\")
		print(n.imunidade) 
		print(\"é paciente zero ?\")
		print(n.pacienteZero)
		
# Called every frame. 'delta' is the elapsed time since the previous frame.
#func _process(delta):
#	pass


func _on_Button_button_down():
	if(isolado == \"\"):
		for p in get_children():
			if(p.name == selecionado):
				p.get_node(\"Button\").disabled = true
				isolado = selecionado
"

[sub_resource type="GDScript" id=7]
script/source = "extends Node


# Declare member variables here. Examples:
var imunidade:int
var isolada:bool = false
var morta:bool = false
var doente:bool = false
var pacienteZero:bool = false
var maximo_contatos:int = 2
var turnoAdoecimento
var texto: String


# Called when the node enters the scene tree for the first time.
func _ready():
	pass
	

# Called every frame. 'delta' is the elapsed time since the previous frame.
#func _process(delta):

func formatarInteracoes():
	texto += \"Adoeceu Turno \"+ str(turnoAdoecimento)+ \"\\n\"

func _on_Button_button_down():
	texto = \"Nome: \"+str(name)+\"\\n\"
	get_parent().get_parent().get_node(\"Population\").selecionado = name
	if(doente):
		formatarInteracoes()
	else : 
		texto += \"Essa pessoa ainda não foi ao hospital!\"
	get_parent().get_parent().get_node(\"painel\").set_text(texto)
"

[node name="Town" type="Node2D"]
script = SubResource( 1 )

[node name="background_color" type="Sprite" parent="."]
position = Vector2( 640, 360 )
scale = Vector2( 1280, 720 )
texture = SubResource( 3 )
region_rect = Rect2( 1280, 0, 0, 0 )
__meta__ = {
"_edit_lock_": true
}

[node name="InfoTurno" type="Label" parent="."]
margin_left = 168.833
margin_top = 12.658
margin_right = 457.833
margin_bottom = 68.658
custom_styles/normal = SubResource( 4 )
align = 1
valign = 1
autowrap = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="painel" type="Label" parent="."]
margin_left = 949.569
margin_top = 52.7862
margin_right = 1240.57
margin_bottom = 415.786
custom_styles/normal = SubResource( 5 )
custom_colors/font_color = Color( 0, 0, 0, 1 )
text = "Informações"
align = 1
valign = 1
autowrap = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="painel2" type="Label" parent="."]
margin_left = 950.0
margin_top = 443.0
margin_right = 1241.0
margin_bottom = 674.0
custom_styles/normal = SubResource( 5 )
custom_colors/font_color = Color( 0, 0, 0, 1 )
text = "
Anotações"
align = 1
autowrap = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="TextEdit" type="TextEdit" parent="painel2"]
margin_left = 1.0
margin_top = 34.0
margin_right = 290.0
margin_bottom = 230.0
text = "(escreva o que quiser aqui)"
show_line_numbers = true
wrap_enabled = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Places" type="Node2D" parent="."]
visible = false
position = Vector2( 0, 42.6477 )

[node name="Mall" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/Mall"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 649.0
margin_top = 306.0
margin_right = 661.0
margin_bottom = 326.0
rect_scale = Vector2( 0.347381, 0.36 )
custom_colors/font_color = Color( 0, 0, 0, 1 )
icon = ExtResource( 6 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="School" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/School"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 484.0
margin_top = 403.0
margin_right = 849.0
margin_bottom = 835.0
rect_scale = Vector2( 0.347381, 0.36 )
icon = ExtResource( 2 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Market" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/Market"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 483.0
margin_top = 62.0
margin_right = 848.0
margin_bottom = 494.0
rect_scale = Vector2( 0.347381, 0.36 )
icon = ExtResource( 7 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Restaurant" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/Restaurant"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 217.0
margin_top = 339.0
margin_right = 582.0
margin_bottom = 771.0
rect_scale = Vector2( 0.347381, 0.36 )
icon = ExtResource( 4 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Work" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/Work"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 300.0
margin_top = 199.0
margin_right = 665.0
margin_bottom = 671.0
rect_scale = Vector2( 0.347381, 0.36 )
icon = ExtResource( 3 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Airport" type="Node2D" parent="Places"]
script = ExtResource( 18 )

[node name="Button" type="Button" parent="Places/Airport"]
modulate = Color( 0.776471, 0.713726, 0.713726, 1 )
margin_left = 757.0
margin_top = 211.0
margin_right = 1122.0
margin_bottom = 643.0
rect_scale = Vector2( 0.347381, 0.36 )
icon = ExtResource( 5 )
flat = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Population" type="Node2D" parent="."]
script = SubResource( 6 )
__meta__ = {
"_edit_lock_": true
}

[node name="Cal" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Cal"]
margin_left = 47.8818
margin_top = 142.418
margin_right = 120.882
margin_bottom = 178.418
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Cal"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Mark" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Mark"]
margin_left = 46.6541
margin_top = 342.539
margin_right = 119.654
margin_bottom = 378.539
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Mark"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Sinty" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Sinty"]
margin_left = 46.6541
margin_top = 292.202
margin_right = 119.654
margin_bottom = 328.202
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Sinty"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Eron" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Eron"]
margin_left = 47.8818
margin_top = 241.865
margin_right = 120.882
margin_bottom = 277.865
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Eron"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Judite" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Judite"]
margin_left = 47.8818
margin_top = 190.3
margin_right = 120.882
margin_bottom = 226.3
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Judite"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Neil" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Neil"]
margin_left = 45.5491
margin_top = 394.411
margin_right = 118.549
margin_bottom = 430.411
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Neil"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Margaret" type="Node" parent="Population"]
script = SubResource( 7 )

[node name="Button" type="Button" parent="Population/Margaret"]
margin_left = 45.5491
margin_top = 442.232
margin_right = 118.549
margin_bottom = 478.232
custom_colors/font_color = Color( 1, 1, 1, 1 )
text = "Margaret"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Sprites" type="Node" parent="."]

[node name="spr_town2" type="Sprite" parent="Sprites"]
position = Vector2( 575.234, 365.501 )
scale = Vector2( 0.357, 0.357 )
texture = ExtResource( 1 )

[node name="NextTurn" type="Button" parent="."]
margin_left = 473.04
margin_top = 17.4909
margin_right = 590.04
margin_bottom = 66.4909
text = "Proximo Turno"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Isolar" type="Button" parent="."]
margin_left = 43.101
margin_top = 566.636
margin_right = 220.101
margin_bottom = 616.636
text = "Isolar Pessoa Selecionada"
__meta__ = {
"_edit_use_anchors_": false
}
[connection signal="button_down" from="Places/Mall/Button" to="Places/Mall" method="_on_Button_button_down"]
[connection signal="button_down" from="Places/School/Button" to="Places/School" method="_on_Button_button_down"]
[connection signal="button_down" from="Places/Market/Button" to="Places/Market" method="_on_Button_button_down"]
[connection signal="button_down" from="Places/Restaurant/Button" to="Places/Restaurant" method="_on_Button_button_down"]
[connection signal="button_down" from="Places/Work/Button" to="Places/Work" method="_on_Button_button_down"]
[connection signal="button_down" from="Places/Airport/Button" to="Places/Airport" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Cal/Button" to="Population/Cal" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Mark/Button" to="Population/Mark" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Sinty/Button" to="Population/Sinty" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Eron/Button" to="Population/Eron" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Judite/Button" to="Population/Judite" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Neil/Button" to="Population/Neil" method="_on_Button_button_down"]
[connection signal="button_down" from="Population/Margaret/Button" to="Population/Margaret" method="_on_Button_button_down"]
[connection signal="button_down" from="NextTurn" to="." method="_on_NextTurn_button_down"]
[connection signal="button_down" from="Isolar" to="Population" method="_on_Button_button_down"]
